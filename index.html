<!doctype html>
<html lang="rn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boutique Smart ‚Äî Landing Page</title>
  <meta name="description" content="Boutique intelligent ifite chatbot, voice, image-gen, stock search, na contact." />

  <!-- Styles: modern responsive + dark mode + animations -->
  <style>
    /* Basic reset */
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#00d1b2; --glass: rgba(255,255,255,0.04);
      --light-bg:#f4f7fb; --light-card:#ffffff; --text:#e6eef6; --radius:12px;
      --max-width:1100px;
    }
    [data-theme="light"]{
      --bg:var(--light-bg); --card:var(--light-card); --muted:#475569; --text:#0b1220; --glass: rgba(0,0,0,0.04);
    }

    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(180deg,#071026 0%, var(--bg) 100%);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.45;}
    .wrap{max-width:var(--max-width);margin:0 auto;padding:24px;}

    /* Fullscreen video background container */
    .hero{
      position:relative;height:78vh;min-height:420px;border-radius:16px;overflow:hidden;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(2,6,23,0.4), rgba(2,6,23,0.6));
      box-shadow:0 10px 30px rgba(2,6,23,0.6);
    }
    .bg-media{position:absolute;inset:0;object-fit:cover;width:100%;height:100%;}
    .bg-fallback{position:absolute;inset:0;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="900"><rect width="100%" height="100%" fill="%230b1220"/><text x="50%" y="50%" fill="%23ffffff" font-size="36" font-family="Arial" text-anchor="middle">Fallback Image</text></svg>');background-size:cover;background-position:center}
    .hero-content{position:relative;z-index:3;padding:32px;text-align:center;max-width:900px;}
    h1{font-size:clamp(1.6rem,4vw,3rem);margin:0 0 8px;letter-spacing:-0.02em}
    p.lead{margin:0 0 18px;color:var(--muted);font-size:1.05rem}

    .cta-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .btn{
      background:linear-gradient(90deg,var(--accent),#00b59a);border:0;color:#022;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:600;
      box-shadow:0 6px 18px rgba(0,0,0,0.25);transition:transform .16s ease,filter .16s;
    }
    .btn:focus{outline:3px solid rgba(0,209,178,0.18)}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}

    /* Layout grid for sections */
    section{margin:28px 0;padding:18px;border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);backdrop-filter: blur(6px);}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.hero{height:62vh}}

    /* Stock table */
    .stock-table{width:100%;border-collapse:collapse}
    .stock-table th,.stock-table td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left;font-size:0.95rem}
    .product-row{display:flex;gap:12px;align-items:center}
    .product-thumb{width:64px;height:64px;border-radius:8px;flex:0 0 64px;object-fit:cover;background:var(--glass);display:inline-block}

    /* Chat UI */
    .chat{display:flex;flex-direction:column;height:100%;gap:8px}
    .chat-window{flex:1;overflow:auto;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,0.04), transparent)}
    .msg{max-width:78%;padding:10px 12px;border-radius:12px;margin-bottom:8px;display:inline-block}
    .msg.user{background:#0ea5a4;color:#042;align-self:flex-end;border-bottom-right-radius:4px}
    .msg.bot{background:linear-gradient(90deg,#172554,#0b1220);color:var(--text);align-self:flex-start}
    .chat-input{display:flex;gap:8px;align-items:center}
    .chat-input input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);cursor:pointer}

    /* Feedback carousel simple */
    .testimonials{display:flex;gap:12px;overflow:auto;padding:6px}
    .testi{min-width:220px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02)}

    /* Joke spinner */
    .joke-area{text-align:center}
    .spinner{display:inline-block;padding:18px;border-radius:50%;background:rgba(255,255,255,0.02);cursor:pointer}

    /* Footer */
    footer{display:flex;flex-direction:column;gap:8px;font-size:0.95rem;color:var(--muted);align-items:center}

    /* Animated reveal */
    .reveal{opacity:0;transform:translateY(12px);transition:opacity .6s ease,transform .6s ease}
    .reveal.visible{opacity:1;transform:none}

    /* Smooth scroll */
    html{scroll-behavior:smooth}
  </style>
</head>
<body>

  <!-- Top audio greeting in French. Plays muted first to respect autoplay policies then un-mutes on user gesture -->
  <!-- Section comment: Audio greeting to welcome visitors in French -->
  <audio id="greeting-audio" preload="auto">
    <source src="" type="audio/mpeg">
  </audio>

  <div class="wrap">

    <!-- Hero Section: video background + fallback image + title + CTA -->
    <section class="hero" id="hero">
      <!-- Video background: uses an external mp4 URL placeholder; developer can replace with production asset -->
      <video class="bg-media" id="bgVideo" autoplay muted loop playsinline crossorigin="anonymous">
        <source src="https://cdn.coverr.co/videos/coverr-modern-shop-choosing-comes-alive-1592?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9" type="video/mp4">
      </video>
      <div class="bg-fallback" id="fallback"></div>

      <div class="hero-content">
        <h1>Bienvenue chez Boutique Smart</h1>
        <p class="lead">Boutique yacu y'ubwenge: ubucuruzi, service vocal, chatbot mu Kinyarwanda kandi igatanga amafoto ukoresheje ibisobanuro.</p>

        <div class="cta-row" role="navigation" aria-label="Call to actions">
          <button class="btn" id="cta-preorder" aria-label="Dushorere kugiciro gito">Dushorere kugiciro gito</button>
          <button class="btn secondary" id="toggle-theme" aria-pressed="false">Dark / Light</button>
        </div>
      </div>
    </section>

    <!-- Main grid: Stock + Chat -->
    <section class="reveal" id="main-section">
      <div class="grid">
        <!-- Left column: stock, search, feedback, jokes -->
        <div>

          <!-- Stock Section -->
          <!-- Comment: ibicuruzwa bisomwa muri embedded JSON "stockData" -->
          <article id="stock" style="margin-bottom:16px;">
            <h2>Stock y'ibicuruzwa</h2>
            <label for="search" style="color:var(--muted);font-size:0.95rem">Shakisha ibicuruzwa</label>
            <input id="search" type="search" placeholder="Andika izina cyangwa igiciro..." style="width:100%;padding:10px;border-radius:10px;margin-top:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)">

            <div style="margin-top:12px;overflow:hidden;border-radius:12px">
              <table class="stock-table" aria-live="polite" id="stockTable">
                <thead>
                  <tr><th>Image</th><th>Izina / Ibisobanuro</th><th>Igiciro</th></tr>
                </thead>
                <tbody id="stockBody">
                  <!-- Rows injected from JS -->
                </tbody>
              </table>
            </div>
          </article>

          <!-- Feedback Section -->
          <!-- Comment: testimonials with emojis and stars -->
          <article id="feedback" style="margin-bottom:16px;">
            <h2>Amahugurwa y'abakiriya</h2>
            <div class="testimonials" id="testiList" aria-live="polite">
              <!-- JS injects testimonials -->
            </div>
          </article>

          <!-- Daily Joke Spinner -->
          <!-- Comment: spinner chooses unique joke daily stored in localStorage -->
          <article id="jokes" class="joke-area" style="margin-bottom:16px;">
            <h2>Joke ya buri munsi (mu Kirundi)</h2>
            <div style="margin:12px 0">
              <button class="spinner" id="spinJoke" aria-label="Fata joke nshasha">üé≤ Spin</button>
            </div>
            <div id="jokeText" style="min-height:48px;color:var(--muted)"></div>
            <div style="margin-top:10px">
              <button class="btn" id="readJoke">Soma Joke mu ijwi</button>
            </div>
          </article>
        </div>

        <!-- Right column: Chatbot + quick info -->
        <aside style="display:flex;flex-direction:column;gap:12px;align-items:stretch;">
          <!-- Chatbot Section -->
          <!-- Comment: Puter.js style logic implemented below in JS -->
          <article id="chatbot" style="padding:12px;">
            <h2>Chatbot ya Boutique (Puter.js style)</h2>
            <div class="chat" aria-live="polite">
              <div class="chat-window" id="chatWindow" role="log" aria-atomic="false">
                <!-- Messages injected here -->
                <div class="msg bot" id="welcomeMsg">Murakaza neza! Mumbaze ibijyanye n'ibicuruzwa.</div>
              </div>

              <div class="chat-input" style="margin-top:8px;">
                <button class="icon" id="voiceBtn" title="Vuga (voice)">üéôÔ∏è</button>
                <input id="chatInput" placeholder="Andika ikibazo cyawe..." aria-label="Chat input" />
                <button class="icon" id="imgGenBtn" title="Generate Image">üñºÔ∏è</button>
                <button class="btn" id="sendBtn" aria-label="Ohereza">Ohereza</button>
              </div>
              <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                <small style="color:var(--muted)">Chatbot izasubiza mu Kinyarwanda, kandi ijwi rya chatbot rirashobora kuba mu Gifaransa cyangwa Kiswahili.</small>
              </div>
            </div>
          </article>

          <!-- Map Embed / Support -->
          <article id="mapSupport" style="padding:12px;">
            <h3>Aho turi</h3>
            <!-- Google Maps embed using iframe with specified coordinates -->
            <div style="border-radius:10px;overflow:hidden;margin-bottom:10px">
              <iframe title="Gihosha Gisandema map" width="100%" height="200" frameborder="0"
                src="https://www.google.com/maps?q=-3.36392,29.378&z=15&output=embed"></iframe>
            </div>

            <div style="display:flex;gap:8px;flex-direction:column">
              <a href="https://wa.me/25771633859?text=Muraho%20Boutique%20Smart.%20Ndakeneye%20ubufasha." target="_blank" rel="noopener" class="btn">WhatsApp Support</a>
              <div style="color:var(--muted);font-size:0.95rem;margin-top:8px">
                Service maintenance: 24/7. <br>
                üìû +25771633859 | üìß ornoirbruce5@gmail.com
              </div>
            </div>
          </article>
        </aside>
      </div>
    </section>

    <!-- Contact Form -->
    <!-- Comment: Uses FormSubmit.io for POST -->
    <section id="contact" class="reveal">
      <h2>Contact</h2>
      <form action="https://formsubmit.co/ornoirbruce5@gmail.com" method="POST" id="contactForm">
        <input type="hidden" name="_subject" id="prefillSubject" value="Demande de contact ‚Äî Boutique Smart">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input name="name" placeholder="Izina" required style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)">
          <input name="email" type="email" placeholder="Email" required style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)">
        </div>
        <textarea name="message" placeholder="Ubutumwa..." required style="width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button class="btn" type="submit">Ohereza</button>
          <button class="btn secondary" type="button" id="prefillCTA">CTA: Dushorere</button>
        </div>
      </form>
    </section>

    <!-- Footer -->
    <footer class="reveal">
      <div><strong>Contact</strong> üìû +25771633859 | üìß ornoirbruce5@gmail.com | üìç Gihosha Gisandema</div>
      <div style="display:flex;gap:12px;align-items:center">
        <a href="https://wa.me/25771633859" aria-label="WhatsApp" target="_blank">WhatsApp</a>
        <a href="#" aria-label="Instagram">Instagram</a>
        <a href="#" aria-label="Facebook">Facebook</a>
        <!-- Inline QR code using canvas generated by JS for site -->
        <canvas id="qrCanvas" width="88" height="88" style="border-radius:8px;background:var(--glass)"></canvas>
      </div>
      <small style="color:var(--muted)">¬© Boutique Smart ‚Äî Tous droits r√©serv√©s</small>
    </footer>
  </div>

  <!-- Embedded stock JSON (comment: this stands for external JSON inlined) -->
  <script id="stockData" type="application/json">
  [
    {"id":1,"name":"Imvura Jacket","desc":"Jacket y'ibara ryijimye, ifite ubushyuhe n'ubwiza","price":"45,000 BIF","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='%230b1220'/><text x='50%' y='50%' fill='%23fff' font-size='14' text-anchor='middle'>Imvura Jacket</text></svg>"},
    {"id":2,"name":"Ikoti rya Muco","desc":"Ikoti gakondo rifite ubudodo bwa kinyarwanda","price":"65,000 BIF","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='%230b1220'/><text x='50%' y='50%' fill='%23fff' font-size='14' text-anchor='middle'>Ikoti rya Muco</text></svg>"},
    {"id":3,"name":"Agatabo k'Impano","desc":"Agatabo gato ka memoire", "price":"8,000 BIF","img":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='%230b1220'/><text x='50%' y='50%' fill='%23fff' font-size='14' text-anchor='middle'>Agatabo</text></svg>"}
  ]
  </script>

  <!-- Core JavaScript: Puter-style logic, speech, image generator, UI interactions -->
  <script>
    /* ============================
       Utilities & Initialization
       Comments explain each block and purpose
       ============================ */

    // Theme toggle (dark/light) persisted in localStorage
    (function themeInit(){
      const tBtn = document.getElementById('toggle-theme');
      const saved = localStorage.getItem('theme') || 'dark';
      if(saved === 'light') document.documentElement.setAttribute('data-theme','light');
      tBtn.addEventListener('click', ()=>{
        const cur = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', cur === 'light' ? 'light' : 'dark');
        localStorage.setItem('theme', cur);
        tBtn.setAttribute('aria-pressed', cur === 'light');
      });
    })();

    // Simple reveal on scroll
    (function revealObserver(){
      const obs = new IntersectionObserver(entries=>{
        entries.forEach(e=>{
          if(e.isIntersecting) e.target.classList.add('visible');
        });
      }, {threshold:0.12});
      document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));
    })();

    // Greeting audio: generate a short French greeting via SpeechSynthesis first-run
    (function greetingAudio(){
      const synth = window.speechSynthesis;
      const audioEl = document.getElementById('greeting-audio');
      const text = "Bonjour, bienvenue chez Boutique Smart. Nous sommes heureux de vous servir.";
      // Create utterance and capture to Blob via MediaStream if available (fallback: play TTS directly)
      function playGreeting(){ 
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'fr-FR';
        u.rate = 1;
        u.pitch = 1;
        synth.speak(u);
      }
      // Play on first user interaction to satisfy autoplay constraints
      document.addEventListener('click',{once:true,passive:true},playGreeting);
    })();

    /* ============================
       Stock: read embedded JSON and populate table
       ============================ */
    const stock = JSON.parse(document.getElementById('stockData').textContent);
    const stockBody = document.getElementById('stockBody');
    function renderStock(rows){
      stockBody.innerHTML = '';
      rows.forEach((p,i)=>{
        const tr = document.createElement('tr');
        tr.className = 'reveal';
        tr.style.transitionDelay = (i*60)+'ms';
        tr.innerHTML = `
          <td><div class="product-row"><img class="product-thumb" src="${p.img}" alt="${p.name}"></div></td>
          <td><strong>${p.name}</strong><div style="color:var(--muted);font-size:0.92rem">${p.desc}</div></td>
          <td><strong>${p.price}</strong></td>
        `;
        stockBody.appendChild(tr);
        // Animated reveal
        setTimeout(()=>tr.classList.add('visible'), 80 + i*80);
      });
    }
    renderStock(stock);

    // Live search on stock
    document.getElementById('search').addEventListener('input', e=>{
      const q = e.target.value.trim().toLowerCase();
      const filtered = stock.filter(p => (p.name + ' ' + p.desc + ' ' + p.price).toLowerCase().includes(q));
      renderStock(filtered);
    });

    /* ============================
       Testimonials (Feedback section)
       ============================ */
    const testimonials = [
      {name:"Alice",text:"Serivisi nziza cane! ü•∞",rating:5},
      {name:"Jean",text:"Ibicuruzwa byujuje ubuziranenge üòé",rating:4},
      {name:"Marie",text:"Nabonye igiciro cyiza üëç",rating:5}
    ];
    const testiList = document.getElementById('testiList');
    testimonials.forEach(t=>{
      const d = document.createElement('div');
      d.className = 'testi';
      d.innerHTML = `<strong>${t.name}</strong><div style="color:var(--muted)">${t.text} ${"‚≠ê".repeat(t.rating)}</div>`;
      testiList.appendChild(d);
    });

    /* ============================
       Joke Spinner: unique daily joke in Kirundi using localStorage
       ============================ */
    const jokes = [
      "Umukenyezi yabajije: 'Ese urakunda inyama?'; Umugabo ati: 'Ndazikunda ariko sinzizi uko natwika.' üòÇ",
      "Umwana arabaza: 'Papa, telephone yanyu iragenda gute?' Papa: 'Ni smartphone, iriritse!' üòÖ",
      "Umuntu arareba isaha nyinshi, aravuga ati: 'Saa niyo?'. üòÜ"
    ];
    function getDailyJoke(){
      const key = 'boutique:joke:'+new Date().toISOString().slice(0,10);
      let v = localStorage.getItem(key);
      if(v) return v;
      // choose random not used previously this session
      const pool = jokes.slice();
      v = pool[Math.floor(Math.random()*pool.length)];
      localStorage.setItem(key, v);
      return v;
    }
    document.getElementById('spinJoke').addEventListener('click', ()=>{
      const j = getDailyJoke();
      document.getElementById('jokeText').textContent = j;
    });
    document.getElementById('readJoke').addEventListener('click', ()=>{
      const j = document.getElementById('jokeText').textContent || getDailyJoke();
      const u = new SpeechSynthesisUtterance(j);
      u.lang = 'rn-RW' || 'ki-RW';
      speechSynthesis.speak(u);
    });

    /* ============================
       QR Code: simple site QR drawn via canvas (URL fallback)
       ============================ */
    (function drawQR(){
      const c = document.getElementById('qrCanvas');
      if(!c) return;
      const ctx = c.getContext('2d');
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card') || '#0b1220';
      ctx.fillRect(0,0,c.width,c.height);
      // Simple pattern to mimic QR visually (not a valid QR for production)
      ctx.fillStyle = '#fff';
      for(let x=6;x<80;x+=12){
        for(let y=6;y<80;y+=12){
          if(Math.random()>0.6) ctx.fillRect(x,y,6,6);
        }
      }
    })();

    /* ============================
       Contact CTA prefill
       ============================ */
    document.getElementById('prefillCTA').addEventListener('click', ()=>{
      document.getElementById('prefillSubject').value = 'Demande: Dushorere kugiciro gito';
      document.getElementById('contactForm').scrollIntoView({behavior:'smooth'});
    });

    /* ============================
       Puter.js style Chatbot (local, simulated intelligence)
       - Supports: text input, voice recognition (SpeechRecognition), text-to-speech (Kinyarwanda + Kiswahili)
       - Can search stock JSON and respond with emojis and image generation via canvas
       ============================ */

    // Utility: choose emoji based on sentiment/key words
    function pickEmoji(text){
      const t = text.toLowerCase();
      if(/\b(pas|nta|ntab)\b/.test(t)) return "üòï";
      if(/\b(rin|nziza|iza|smile|like| üëç|üòç|üòä)\b/.test(t)) return "üòä";
      if(/\b(igiciro|price|biciro)\b/.test(t)) return "üí∏";
      return "ü§ñ";
    }

    // Simulated Puter module
    const Puter = {
      // simulate intelligence: can answer general Qs, search stock, and call text2img
      async respond(input, opts={voice:true}){
        const q = (input||'').trim();
        // if asks about stock items
        const found = stock.filter(p => (p.name + ' ' + p.desc + ' ' + p.price).toLowerCase().includes(q.toLowerCase()));
        if(found.length){
          const list = found.map(p=>`${p.name} ‚Äî ${p.price}`).join(' ; ');
          return {text:`Nabonye ibi bicuruzwa: ${list}`, meta:{type:'stock',items:found}};
        }
        // image generation trigger
        if(q.toLowerCase().startsWith('image:') || q.toLowerCase().includes('shushanya') || q.toLowerCase().includes('foto')){
          const prompt = q.replace(/^image:\s*/i,'');
          const imgUrl = await Puter.ai.txt2img(prompt || 'Boutique product');
          return {text:`Nakoze ifoto ishingiye ku bisobanuro: "${prompt}" ${pickEmoji(q)}`, meta:{type:'image',src:imgUrl}};
        }
        // default smalltalk (simulate GPT)
        if(/(hello|muraho|bonjour|habari)/i.test(q)) return {text:`Muraho neza! Nitwa Boutique Copilot ${pickEmoji(q)}`};
        if(q.length<3) return {text:'Ndabonye, saba ikibazo kirekire gato kugirango mbashe kugufasha üôè'};
        // fallback: basic helpful response referencing boutique persona
        return {text:`Ndashobora kugufasha kubona ibicuruzwa, kuvuga ijwi, cyangwa gukora ifoto. Wabaza urugero: "Mbwira Imvura Jacket" ${pickEmoji(q)}`};
      },

      // Simulated image generator using canvas -> dataURL
      ai:{
        async txt2img(prompt){
          // simple canvas with prompt text; in prod, replace with real API call
          const w=800,h=600;
          const cvs = document.createElement('canvas'); cvs.width=w; cvs.height=h;
          const ctx = cvs.getContext('2d');
          // background gradient
          const g = ctx.createLinearGradient(0,0,w,h);
          g.addColorStop(0,'#0b1220'); g.addColorStop(1,'#04293a');
          ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
          // draw title
          ctx.fillStyle = '#fff'; ctx.font = '28px sans-serif'; ctx.fillText('Boutique Smart - Preview',20,50);
          ctx.font = '20px sans-serif'; ctx.fillText('Prompt: '+prompt,20,90);
          // draw fake product card
          ctx.fillStyle = '#07363a'; ctx.fillRect(50,120,700,420);
          ctx.fillStyle='#fff'; ctx.font='18px sans-serif'; ctx.fillText(prompt,70,160);
          // decorate
          ctx.fillStyle = '#00d1b2'; ctx.fillRect(70,180,120,6);
          return cvs.toDataURL('image/png');
        }
      }
    };

    // Chat UI interactions
    const chatWindow = document.getElementById('chatWindow');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const imgGenBtn = document.getElementById('imgGenBtn');

    function appendMsg(text, who='bot', extraHtml=''){
      const d = document.createElement('div');
      d.className = 'msg ' + (who==='user'?'user':'bot');
      d.innerHTML = `<div>${text}</div>${extraHtml}`;
      chatWindow.appendChild(d);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function handleSend(raw){
      const text = raw.trim();
      if(!text) return;
      appendMsg(text,'user');
      chatInput.value='';
      // Puter responds
      appendMsg('...', 'bot');
      const resp = await Puter.respond(text);
      // replace last bot '...' with actual
      const last = Array.from(chatWindow.querySelectorAll('.msg.bot')).pop();
      if(!last) return;
      last.innerHTML = `<div>${resp.text}</div>`;
      // if meta includes items (stock) display small cards
      if(resp.meta && resp.meta.type === 'stock'){
        const items = resp.meta.items;
        const listHtml = items.map(it=>`<div style="margin-top:8px"><img src="${it.img}" style="width:60px;height:60px;border-radius:8px;vertical-align:middle;margin-right:8px"> <strong>${it.name}</strong> ‚Äî ${it.price}</div>`).join('');
        last.insertAdjacentHTML('beforeend', '<div style="margin-top:8px">'+listHtml+'</div>');
      }
      if(resp.meta && resp.meta.type === 'image'){
        const src = resp.meta.src;
        last.insertAdjacentHTML('beforeend', `<div style="margin-top:12px"><img src="${src}" alt="generated" style="width:100%;border-radius:8px"></div>`);
      }
      // Speak the bot response in Kinyarwanda by default, optionally switch to Kiswahili for greetings
      const u = new SpeechSynthesisUtterance(resp.text);
      // heuristic: use sw if message contains 'habari' or 'asante'
      if(/habari|asante|asanteni/i.test(resp.text)) u.lang = 'sw-KE';
      else u.lang = 'rw-RW' || 'ki-RW';
      u.rate = 1;
      u.pitch = 1;
      speechSynthesis.speak(u);
    }

    sendBtn.addEventListener('click', ()=>handleSend(chatInput.value));
    chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter') handleSend(chatInput.value); });

    // Image generation button triggers Puter.ai.txt2img with current input or prompt modal
    imgGenBtn.addEventListener('click', async ()=>{
      const prompt = chatInput.value.trim() || promptInputDialog();
      if(!prompt) return;
      appendMsg('Ndi gukora ifoto...', 'bot');
      const result = await Puter.ai.txt2img(prompt);
      appendMsg(`Ifoto yakozwe: ${pickEmoji(prompt)}`, 'bot', `<div style="margin-top:8px"><img src="${result}" alt="ai" style="width:100%;border-radius:8px"></div>`);
    });

    function promptInputDialog(){
      return window.prompt('Andika ibisobanuro byifoto (ex: Ikoti rya kinyarwanda, ibara ritukura)') || '';
    }

    /* ============================
       Voice recognition: SpeechRecognition in Kinyarwanda
       - Fallback: show not supported
       ============================ */
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SpeechRecognition){
      const rec = new SpeechRecognition();
      rec.lang = 'rw-RW'; // attempt Kinyarwanda locale; browser may fallback
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      let listening=false;
      voiceBtn.addEventListener('click', ()=>{
        if(!listening){ try{ rec.start(); voiceBtn.textContent='üî¥'; listening=true;}catch(e){console.warn(e)} }
        else{ rec.stop(); voiceBtn.textContent='üéôÔ∏è'; listening=false; }
      });
      rec.addEventListener('result', e=>{
        const text = e.results[0][0].transcript;
        handleSend(text);
        voiceBtn.textContent='üéôÔ∏è'; listening=false;
      });
      rec.addEventListener('error', e=>{ console.warn('Speech error', e); voiceBtn.textContent='üéôÔ∏è'; listening=false; appendMsg('Voice recognition error','bot'); });
      rec.addEventListener('end', ()=>{ listening=false; voiceBtn.textContent='üéôÔ∏è'; });
    } else {
      voiceBtn.addEventListener('click', ()=>{ alert('Voice recognition not supported in this browser'); });
    }

    /* ============================
       CTA "Dushorere kugiciro gito" focus + accessibility
       - Prefill subject and focus contact form
       ============================ */
    document.getElementById('cta-preorder').addEventListener('click', ()=>{
      document.getElementById('prefillSubject').value = 'Pre-order: Dushorere kugiciro gito';
      document.getElementById('contactForm').scrollIntoView({behavior:'smooth'});
      document.querySelector('#contactForm [name="name"]').focus();
    });

    /* ============================
       Page load: show fallback if video fails
       ============================ */
    const bgVideo = document.getElementById('bgVideo');
    const fallback = document.getElementById('fallback');
    bgVideo.addEventListener('error', ()=>{ bgVideo.style.display='none'; fallback.style.display='block'; });
    // if video is blocked (autoplay), show fallback
    setTimeout(()=>{ if(bgVideo.readyState < 2){ bgVideo.style.display='none'; fallback.style.display='block'; } }, 1500);

    /* ============================
       Small accessibility: keyboard shortcuts
       - '/' focuses search, 'c' focuses chat input, 'j' spins joke
       ============================ */
    document.addEventListener('keydown', e=>{
      if(e.key === '/') { e.preventDefault(); document.getElementById('search').focus(); }
      if(e.key === 'c') document.getElementById('chatInput').focus();
      if(e.key === 'j') document.getElementById('spinJoke').click();
    });

    /* ============================
       Final: small welcome bot message to act like a boutique employee
       - Greets visitor and offers to show stock
       ============================ */
    setTimeout(()=>{
      appendMsg('Murakaza neza! Nitwa Boutique Copilot. Nabaza ushaka kureba ibicuruzwa cyangwa kuvugana na support? üòä', 'bot');
    }, 1400);

  </script>
</body>
</html>
